<!-- Contenedor principal estilo MercadoLibre -->
@if (producto$ | async; as producto) {
  @if (producto) {
    <div class="producto-detalle-container">
      <!-- Breadcrumb estilo ML -->
      <nav class="breadcrumb-nav">
        <ol class="breadcrumb-list">
          <li><a routerLink="/" class="breadcrumb-link">Inicio</a></li>
          <li class="breadcrumb-separator">></li>
          <li><a routerLink="/productos" class="breadcrumb-link">{{ producto.categoria }}</a></li>
          <li class="breadcrumb-separator">></li>
          <li class="breadcrumb-current">{{ producto.nombre }}</li>
        </ol>
      </nav>

      <div class="producto-layout">
        <!-- Columna Izquierda: Imagen -->
        <div class="imagen-section">
          <div class="imagen-container">
            @if (producto.imagen) {
              <img [src]="producto.imagen" 
                   class="producto-imagen-principal" 
                   [alt]="producto.nombre"
                   (error)="onImageError($event)">
            } @else {
              <div class="imagen-placeholder">
                <i class="bi bi-image"></i>
                <span>Sin imagen</span>
              </div>
            }
          </div>
          
          <!-- Miniaturas (futuro) -->
          <div class="miniaturas-container">
            <div class="miniatura activa">
              @if (producto.imagen) {
                <img [src]="producto.imagen" [alt]="producto.nombre">
              } @else {
                <i class="bi bi-image"></i>
              }
            </div>
          </div>
        </div>

        <!-- Columna Derecha: Información -->
        <div class="info-section">
          <!-- Título y categoría -->
          <div class="producto-header">
            <span class="categoria-badge">{{ producto.categoria }}</span>
            <h1 class="producto-titulo">{{ producto.nombre }}</h1>
          </div>

          <!-- Precio principal -->
          <div class="precio-section">
            <div class="precio-principal">
              {{ producto.precio | currency:'ARS':'symbol':'1.0-0' }}
            </div>
            <div class="precio-cuotas">
              en 12x {{ (producto.precio / 12) | currency:'ARS':'symbol':'1.0-0' }} sin interés
            </div>
            @if (producto.precio > 50000) {
              <div class="envio-gratis">
                <i class="bi bi-truck"></i>
                <span>Envío gratis a todo el país</span>
              </div>
            } @else {
              <div class="envio-info">
                <i class="bi bi-truck"></i>
                <span>Envío $1.000 | Gratis a partir de $50.000</span>
              </div>
            }
          </div>

          <!-- Stock -->
          @if (producto.stock !== undefined) {
            <div class="stock-section">
              @if (producto.stock > 0) {
                <div class="stock-disponible">
                  <i class="bi bi-check-circle-fill"></i>
                  <span>Stock disponible ({{ producto.stock }} unidades)</span>
                </div>
              } @else {
                <div class="stock-agotado">
                  <i class="bi bi-x-circle-fill"></i>
                  <span>Sin stock</span>
                </div>
              }
            </div>
          }

          <!-- Botones de acción -->
          <div class="acciones-section">
            <button class="btn-comprar" 
                    (click)="agregarAlCarrito(producto)"
                    [disabled]="producto.stock === 0">
              @if (producto.stock === 0) {
                <i class="bi bi-x-circle mr-2"></i>
                Sin stock
              } @else {
                <i class="bi bi-cart-plus mr-2"></i>
                Agregar al carrito
              }
            </button>
            
            <button class="btn-favorito" (click)="toggleFavorito()">
              <i class="bi bi-heart"></i>
              Agregar a favoritos
            </button>
          </div>

          <!-- Información del vendedor con datos reales -->
          <div class="vendedor-section">
            <div class="vendedor-info">
              <div class="vendedor-avatar">
                <i class="bi bi-shop"></i>
              </div>
              <div class="vendedor-datos">
                <div class="vendedor-nombre">{{ configuracionService.configuracionSignal().titulo }}</div>
                <div class="vendedor-reputacion">
                  <span class="reputacion-badge">{{ estadisticasVendedor?.reputacion || 'MercadoLíder' }}</span>
                  <div class="estrellas">
                    @if (estadisticasVendedor) {
                      @for (estrella of [1,2,3,4,5]; track estrella) {
                        <i class="bi" 
                           [class.bi-star-fill]="estrella <= Math.floor(estadisticasVendedor.calificacionPromedio)"
                           [class.bi-star-half]="estrella === Math.ceil(estadisticasVendedor.calificacionPromedio) && estadisticasVendedor.calificacionPromedio % 1 !== 0"
                           [class.bi-star]="estrella > Math.ceil(estadisticasVendedor.calificacionPromedio)">
                        </i>
                      }
                      <span class="rating-text">{{ estadisticasVendedor.calificacionPromedio | number:'1.1-1' }} ({{ estadisticasVendedor.totalVentas | number }} ventas)</span>
                    } @else {
                      <i class="bi bi-star-fill"></i>
                      <i class="bi bi-star-fill"></i>
                      <i class="bi bi-star-fill"></i>
                      <i class="bi bi-star-fill"></i>
                      <i class="bi bi-star-half"></i>
                      <span class="rating-text">Cargando...</span>
                    }
                  </div>
                </div>
                <div class="vendedor-detalles">
                  <small class="vendedor-experiencia">
                    <i class="bi bi-calendar"></i>
                    @if (estadisticasVendedor && estadisticasVendedor.fechaRegistro) {
                      Vendiendo desde {{ estadisticasVendedor.fechaRegistro | date:'MMMM yyyy':'':'es' }}
                    } @else {
                      Vendiendo desde marzo 2020
                    }
                  </small>
                  <small class="vendedor-positivas">
                    <i class="bi bi-hand-thumbs-up"></i>
                    {{ estadisticasVendedor?.porcentajePositivas || 98.5 }}% de opiniones positivas
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Garantías y beneficios -->
          <div class="garantias-section">
            <h3>Lo que tienes que saber de este producto</h3>
            <ul class="garantias-lista">
              <li>
                <i class="bi bi-shield-check"></i>
                <span>Compra Protegida, recibe el producto que esperabas o te devolvemos tu dinero.</span>
              </li>
              <li>
                <i class="bi bi-arrow-return-left"></i>
                <span>Garantía del vendedor: 30 días</span>
              </li>
              <li>
                <i class="bi bi-credit-card"></i>
                <span>Medios de pago: Tarjetas de crédito, débito, efectivo y más</span>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Descripción detallada -->
      @if (producto.descripcion) {
        <div class="descripcion-section">
          <h2>Descripción</h2>
          <div class="descripcion-contenido">
            <p>{{ producto.descripcion }}</p>
          </div>
        </div>
      }

      <!-- Componente de reseñas -->
      <app-resenas [productoId]="producto.id || ''"></app-resenas>

      <!-- Botón volver -->
      <div class="volver-section">
        <button class="btn-volver" routerLink="/productos">
          <i class="bi bi-arrow-left mr-2"></i>
          Volver a resultados
        </button>
      </div>
    </div>
  } @else {
    <!-- Mensaje si el producto no se encuentra -->
    <div class="error-container">
      <div class="error-content">
        <i class="bi bi-exclamation-triangle"></i>
        <h2>¡Ups! No encontramos la publicación</h2>
        <p>Puede que la publicación haya finalizado o que no esté disponible.</p>
        <button class="btn-volver" routerLink="/productos">
          <i class="bi bi-arrow-left mr-2"></i>
          Ir a la página principal
        </button>
      </div>
    </div>
  }
} @else {
  <!-- Indicador de carga -->
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <p>Cargando producto...</p>
  </div>
}
