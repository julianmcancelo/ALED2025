<!-- GESTI√ìN DE PRODUCTOS - Componente principal para administrar productos -->
<div class="container-fluid">
  <!-- ENCABEZADO - T√≠tulo de la p√°gina y botones de acci√≥n -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h3 mb-0"><i class="bi bi-box-seam-fill me-2"></i>Gesti√≥n de Productos</h2>
    <div class="d-flex gap-2">
      <button
        class="btn btn-outline-secondary"
        (click)="mostrarGestionCategorias = !mostrarGestionCategorias"
      >
        <i class="bi bi-tags-fill me-2"></i>Gestionar Categor√≠as
      </button>
      <button class="btn btn-primary" (click)="nuevoProducto()" *ngIf="!mostrarFormulario">
        <i class="bi bi-plus-circle me-2"></i>Nuevo Producto
      </button>
    </div>
  </div>

  <!-- SECCI√ìN DE GESTI√ìN DE CATEGOR√çAS (NUEVA) -->
  <div class="row mb-4" *ngIf="mostrarGestionCategorias">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0"><i class="bi bi-tags me-2"></i>Categor√≠as</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <!-- Columna para listar categor√≠as -->
            <div class="col-md-7">
              <ul class="list-group">
                <li
                  *ngFor="let cat of categorias"
                  class="list-group-item d-flex justify-content-between align-items-center"
                >
                  <!-- Muestra el nombre de la categor√≠a o un input si se est√° editando -->
                  <ng-container *ngIf="categoriaEnEdicion?.id !== cat.id; else edicionTpl">
                    {{ cat.nombre }}
                  </ng-container>
                  <ng-template #edicionTpl>
                    <input
                      type="text"
                      class="form-control form-control-sm"
                      [(ngModel)]="nombreNuevaCategoria"
                      (keyup.enter)="guardarCategoria()"
                      (keyup.escape)="cancelarEdicionCategoria()"
                    />
                  </ng-template>

                  <!-- Acciones para editar/eliminar -->
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" (click)="editarCategoria(cat)">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger" (click)="eliminarCategoria(cat)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </li>
                <li *ngIf="categorias.length === 0" class="list-group-item text-muted">
                  No hay categor√≠as.
                </li>
              </ul>
            </div>
            <!-- Columna para crear nueva categor√≠a -->
            <div class="col-md-5">
              <h6>{{ categoriaEnEdicion ? 'Editar' : 'Crear Nueva' }} Categor√≠a</h6>
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="nombreNuevaCategoria"
                  placeholder="Nombre de la categor√≠a"
                  (keyup.enter)="guardarCategoria()"
                />
                <button class="btn btn-success" (click)="guardarCategoria()">
                  {{ categoriaEnEdicion ? 'Actualizar' : 'Crear' }}
                </button>
                <button
                  class="btn btn-secondary"
                  *ngIf="categoriaEnEdicion"
                  (click)="cancelarEdicionCategoria()"
                >
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FORMULARIO DE PRODUCTO (MODIFICADO) -->
  <div class="row mb-4" *ngIf="mostrarFormulario">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-{{ modoEdicion ? 'pencil' : 'plus' }}-square me-2"></i>
            {{ modoEdicion ? 'Editar' : 'Nuevo' }} Producto
          </h5>
        </div>
        <div class="card-body">
          <form (ngSubmit)="guardarProducto()">
            <div class="row">
              <!-- CAMPO: Nombre del producto -->
              <div class="col-md-6 mb-3">
                <label for="nombre" class="form-label">Nombre del Producto *</label>
                <input
                  type="text"
                  class="form-control"
                  id="nombre"
                  [(ngModel)]="formularioProducto.nombre"
                  name="nombre"
                  required
                />
              </div>

              <!-- CAMPO: Categor√≠a del producto (DIN√ÅMICO) -->
              <div class="col-md-6 mb-3">
                <label for="categoria" class="form-label">Categor√≠a *</label>
                <select
                  class="form-select"
                  id="categoria"
                  [(ngModel)]="formularioProducto.categoria"
                  name="categoria"
                  required
                >
                  <option value="">Seleccione una categor√≠a</option>
                  <option *ngFor="let cat of categorias" [value]="cat.nombre">
                    {{ cat.nombre }}
                  </option>
                </select>
              </div>

              <!-- Otros campos del formulario (descripci√≥n, precio, etc.) -->
              <div class="col-12 mb-3">
                <label for="descripcion" class="form-label">Descripci√≥n</label>
                <textarea
                  class="form-control"
                  id="descripcion"
                  [(ngModel)]="formularioProducto.descripcion"
                  name="descripcion"
                  rows="3"
                ></textarea>
              </div>
              <div class="col-md-4 mb-3">
                <label for="precio" class="form-label">Precio *</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input
                    type="number"
                    class="form-control"
                    id="precio"
                    [(ngModel)]="formularioProducto.precio"
                    name="precio"
                    min="0"
                    step="0.01"
                    required
                  />
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <label for="stock" class="form-label">Stock</label>
                <input
                  type="number"
                  class="form-control"
                  id="stock"
                  [(ngModel)]="formularioProducto.stock"
                  name="stock"
                  min="0"
                />
              </div>
              <div class="col-md-4 mb-3">
                <label for="activo" class="form-label">Estado</label>
                <select
                  class="form-select"
                  id="activo"
                  [(ngModel)]="formularioProducto.activo"
                  name="activo"
                  title="Estado de disponibilidad del producto"
                >
                  <option [value]="true">Activo</option>
                  <option [value]="false">Inactivo</option>
                </select>
              </div>

              <!-- CAMPO: Destacar producto -->
              <div class="col-12 mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="esDestacado"
                    [(ngModel)]="formularioProducto.esDestacado"
                    name="esDestacado"
                  />
                  <label class="form-check-label" for="esDestacado">
                    Destacar este producto en la p√°gina de inicio (Novedades y Ofertas)
                  </label>
                </div>
              </div>
              <div class="col-12 mb-3">
                <label for="imagen" class="form-label">URL de Imagen</label>
                <input
                  type="url"
                  class="form-control"
                  id="imagen"
                  [(ngModel)]="formularioProducto.imagen"
                  name="imagen"
                />
              </div>

              <!-- SECCI√ìN GEMINI AI -->
              <div class="col-12 mb-4">
                <div class="card border-primary">
                  <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                      <i class="bi bi-robot me-2"></i>ü§ñ An√°lisis REAL con Gemini 2.5 Flash
                      <span class="badge bg-light text-success ms-2">
                        {{ geminiConfigurado ? 'üöÄ ACTIVO' : '‚ùå API KEY REQUERIDA' }}
                      </span>
                      <small class="d-block mt-1">üåç Mercado Argentino 2025 | üí∞ Precios Reales</small>
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="alert alert-info mb-3">
                      <i class="bi bi-lightning-charge-fill me-1"></i>
                      <strong>Sistema 100% Real:</strong> An√°lisis autom√°tico con IA de Google para generar datos comerciales precisos del mercado argentino 2025.
                    </div>

                    <!-- Subir imagen para an√°lisis -->
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label for="imagenGemini" class="form-label">
                          <i class="bi bi-camera me-1"></i>Seleccionar Imagen para An√°lisis
                        </label>
                        <input
                          type="file"
                          class="form-control"
                          id="imagenGemini"
                          accept="image/*"
                          (change)="onImagenSeleccionada($event)"
                        />
                      </div>
                      <div class="col-md-6" *ngIf="imagenSeleccionada">
                        <label class="form-label">Vista Previa</label>
                        <div class="border rounded p-2">
                          <img [src]="imagenSeleccionada" class="img-fluid rounded" style="max-height: 100px;" alt="Vista previa">
                        </div>
                      </div>
                    </div>

                    <!-- Botones de an√°lisis -->
                    <div class="d-flex flex-wrap gap-2 mb-3" *ngIf="imagenSeleccionada">
                      <button
                        type="button"
                        class="btn btn-success"
                        (click)="analizarConGeminiIA('completo')"
                        [disabled]="analizandoConGemini || !geminiConfigurado"
                      >
                        <i class="bi bi-robot me-1"></i>
                        <span *ngIf="!analizandoConGemini">üöÄ An√°lisis REAL Completo</span>
                        <span *ngIf="analizandoConGemini">
                          <span class="spinner-border spinner-border-sm me-1"></span>Procesando con Gemini AI...
                        </span>
                      </button>

                      <button
                        type="button"
                        class="btn btn-outline-success"
                        (click)="analizarConGeminiIA('descripcion')"
                        [disabled]="analizandoConGemini || !geminiConfigurado"
                      >
                        <i class="bi bi-file-text me-1"></i>üìù Descripci√≥n Real
                      </button>

                      <button
                        type="button"
                        class="btn btn-outline-success"
                        (click)="analizarConGeminiIA('precio')"
                        [disabled]="analizandoConGemini || !geminiConfigurado"
                      >
                        <i class="bi bi-currency-dollar me-1"></i>üí∞ Precio Argentina 2025
                      </button>

                      <button
                        type="button"
                        class="btn btn-outline-info"
                        (click)="diagnosticarGeminiAI()"
                        [disabled]="analizandoConGemini"
                      >
                        <i class="bi bi-gear me-1"></i>üîç Diagn√≥stico
                      </button>

                      <button
                        type="button"
                        class="btn btn-outline-warning"
                        (click)="probarAnalisisTexto()"
                        [disabled]="analizandoConGemini"
                      >
                        <i class="bi bi-file-text me-1"></i>üìù Prueba Texto
                      </button>

                      <button
                        type="button"
                        class="btn btn-outline-secondary"
                        (click)="limpiarDatosGemini()"
                        [disabled]="analizandoConGemini"
                      >
                        <i class="bi bi-trash me-1"></i>Limpiar
                      </button>
                    </div>

                    <!-- Resultado del an√°lisis -->
                    <div class="alert alert-success" *ngIf="resultadoGemini && !analizandoConGemini">
                      <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>An√°lisis Completado</strong>
                        <span class="badge bg-success ms-auto">{{ resultadoGemini.confianza }}% confianza</span>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <small><strong>Nombre:</strong> {{ resultadoGemini.nombre }}</small><br>
                          <small><strong>Categor√≠a:</strong> {{ resultadoGemini.categoria }}</small>
                        </div>
                        <div class="col-md-6">
                          <small><strong>Precio:</strong> ${{ resultadoGemini.precio | number }}</small><br>
                          <small><strong>Tags:</strong> {{ resultadoGemini.tags.join(', ') }}</small>
                        </div>
                      </div>
                      <div class="mt-2">
                        <button
                          type="button"
                          class="btn btn-sm btn-success"
                          (click)="aplicarDatosGemini()"
                        >
                          <i class="bi bi-check2-all me-1"></i>Aplicar al Formulario
                        </button>
                      </div>
                    </div>

                    <!-- Estado de carga REAL -->
                    <div class="text-center py-4" *ngIf="analizandoConGemini">
                      <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Procesando...</span>
                      </div>
                      <h6 class="mt-3 text-success">
                        <i class="bi bi-robot me-2"></i>ü§ñ Gemini 2.5 Flash Procesando...
                      </h6>
                      <p class="text-muted">
                        üåç Analizando para mercado argentino 2025<br>
                        üí∞ Calculando precios reales competitivos
                      </p>
                      <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-success">
                <i class="bi bi-check-circle me-2"></i>{{ modoEdicion ? 'Actualizar' : 'Crear' }}
                Producto
              </button>
              <button type="button" class="btn btn-secondary" (click)="cancelarFormulario()">
                <i class="bi bi-x-circle me-2"></i>Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- LISTA DE PRODUCTOS (Sin cambios) -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0"><i class="bi bi-list-ul me-2"></i>Lista de Productos</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Imagen</th>
                  <th>Nombre</th>
                  <th>Categor√≠a</th>
                  <th>Precio</th>
                  <th>Stock</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let producto of productos">
                  <td>
                    <img
                      [src]="producto.imagen || 'assets/images/no-image.png'"
                      [alt]="producto.nombre"
                      class="admin-product-thumbnail"
                      title="Imagen de {{ producto.nombre }}"
                    />
                  </td>
                  <!-- Columna: Nombre del producto con indicador de destacado -->
                  <td>
                    {{ producto.nombre }} @if (producto.esDestacado) {
                    <i class="bi bi-star-fill text-warning ms-1" title="Producto Destacado"></i>
                    }
                  </td>
                  <td>{{ producto.categoria }}</td>
                  <td>{{ producto.precio | currency:'USD':'symbol':'1.2-2' }}</td>
                  <td>
                    <span
                      class="badge"
                      [class]="(producto.stock ?? 0) > 0 ? 'bg-success' : 'bg-danger'"
                      >{{ producto.stock ?? 0 }}</span
                    >
                  </td>
                  <td>
                    <span class="badge" [class]="producto.activo ? 'bg-success' : 'bg-secondary'"
                      >{{ producto.activo ? 'Activo' : 'Inactivo' }}</span
                    >
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-primary" (click)="editarProducto(producto)">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-outline-danger" (click)="eliminarProducto(producto)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="productos.length === 0">
                  <td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-inbox display-4 d-block mb-2"></i>No hay productos registrados
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
